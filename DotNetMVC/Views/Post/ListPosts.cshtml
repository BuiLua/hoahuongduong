
@{
    ViewBag.Title = "ListPosts";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@model FirstDatabaseProject.ViewModels.ListPostsViewModel

@section scripts {
    <script>
        //mở modal them mới 
        $(document).ready(function () {
            $('.btn-open-new-post').on('click', function (event) {
                //Mở modal ở đây
                $('#modal-add-new-post').modal('show');
            });
        });

        //thêm mới post
        $('.btn-add-new-post').on('click', function (event) {

            //lấy thông tin
            var blogId = $('#new-post-blog-id').val();
            var postTitle = $('#new-post-title').val();
            var postContent = $('#new-post-content').val();

            //Kiểm tra chuỗi khác rống
            if (postTitle && postTitle !== '' && postTitle.trim() !== '' &&
                postContent && postContent !== '' && postContent.trim() !== '') {

                //Gọi ajax lên Server
                $.ajax({
                    type: 'post',
                    url: "/Post/AddNewPost",
                    data: {
                        Title: postTitle,
                        Content: postContent,
                        BlogId: blogId
                    },
                    success: function (response) {
                        if (response.isSuccess) {
                            //Tu dong F5 trang web
                            Swal(
                                'Thành công',
                                '',
                                'success'
                            ).then(function () {
                                location.reload();
                            });
                        } else {
                            Swal({
                                type: 'error',
                                title: '',
                                text: 'Xảy ra lỗi khi thêm mới!'
                            });
                        }
                    }
                });
            } else {
                Swal({
                    type: 'error',
                    title: '',
                    text: 'Dữ liệu không hợp lệ!'
                });
            }
        });



        //mở modal sửa post
        $('.btn-open-edit-post').on('click', function (event) {

            var self = $(this);
            var modalUpdate = $('#modal-update-post');
            modalUpdate.find('.modal-title').html('Edit post : ' + self.data('post-title'));
            modalUpdate.find('.btn-update-post').data('post-id', self.data('post-id'));
            $('#edit-post-title').val(self.data('post-title'));
            $('#edit-post-content').val(self.data('post-content'));

            //Mở modal ở đây
            modalUpdate.modal('show');
        });

        //sua post
        $('.btn-update-post').on('click', function (event) {

            var self = $(this);

            //Kiểm tra nội dung text blog-name và gọi lưu thông tin
            var postId = self.data('post-id');
            var blogId = $('#edit-post-blog-id').val();
            var postTitle = $('#edit-post-title').val();
            var postContent = $('#edit-post-content').val();

            //Kiểm tra chuỗi khác rống
            if (postTitle && postTitle !== '' && postTitle.trim() !== '' &&
                postContent && postContent !== '' && postContent.trim() !== '') {
                //Gọi ajax lên Server
                $.ajax({
                    type: 'post',
                    url: "/Post/UpdatePost",
                    data: {
                        Title: postTitle,
                        Content: postContent,
                        BlogId: blogId,
                        PostId: postId
                    },
                    success: function (response) {
                        if (response.isSuccess) {
                            //Tu dong F5 trang web
                            Swal(
                                'Thành công',
                                '',
                                'success'
                            ).then(function () {
                                location.reload();
                            });
                        } else {
                            Swal({
                                type: 'error',
                                title: '',
                                text: 'Xảy ra lỗi khi update!'
                            });
                        }
                    }
                });
            } else {
                Swal({
                    type: 'error',
                    title: '',
                    text: 'Dữ liệu không hợp lệ!'
                });
            }
        });


        //xóa post
        $('.btn-delete-post').on('click', function () {

            var self = $(this);
            var postTitle = self.data("post-title");
            var postId = self.data("post-id");

            Swal.fire({
                title: `Bạn có chắc muốn xóa post ${postTitle}?`,
                text: "",
                type: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Đồng ý!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.value) {
                    //Gọi ajax lên Server
                    $.ajax({
                        type: 'post',
                        url: "/Post/DeletePost",
                        data: {
                            postId: postId
                        },
                        success: function (response) {
                            if (response.isSuccess) {
                                //Tu dong F5 trang web
                                Swal(
                                    'Thành công',
                                    '',
                                    'success'
                                ).then(function () {
                                    location.reload();
                                });
                            } else {
                                Swal({
                                    type: 'error',
                                    title: '',
                                    text: 'Xảy ra lỗi khi delete!'
                                });
                            }
                        }
                    });
                }
            })
        });
    </script>
}


<div class="panel panel-primary margin-top-20">
    <div class="panel-heading">Current blog infor</div>
    <div class="panel-body">
        <h1>Welcom to @Model.CurrentBlog.Name</h1>

    </div>
</div>

<div class="margin-top-20">
    <button type="button" class="btn btn-info btn-open-new-post">Create new post in this blog</button>
</div>

<table class="table table-bordered table-striped margin-top-20">
    <thead>
        <tr>
            <th>PostId</th>
            <th>BlogId</th>
            <th>Title</th>
            <th>Content</th>
            <th>Options</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var post in Model.ListPosts)
        {
            <tr>
                <td>@post.PostId</td>
                <td>@post.BlogId</td>
                <td>@post.Title</td>
                <td>@post.Content</td>
                <td>
                    <button type="button" class="btn btn-primary btn-open-edit-post" 
                            data-post-id="@post.PostId"
                            data-post-title="@post.Title" 
                            data-post-content="@post.Content">Edit</button>
                    <button type="button" class="btn btn-success btn-delete-post" data-post-id="@post.PostId" data-post-title="@post.Title">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

@*Modal them post*@
<div id="modal-add-new-post" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add new post</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" value="@Model.CurrentBlog.BlogId" id="new-post-blog-id" />



                <div class="form-group">
                    <label for="new-post-title">Post Title</label>
                    <input type="text" class="form-control" id="new-post-title">
                </div>
                <div class="form-group">
                    <label for="new-post-content">Post Content</label>
                    <textarea type="text" class="form-control" id="new-post-content" rows="5"></textarea>
                </div>
                <button type="button" class="btn btn-success btn-add-new-post">Add</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success btn-add-new-post">Add</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>


@*Modal sua post*@
<div id="modal-update-post" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Edit post</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" value="@Model.CurrentBlog.BlogId" id="edit-post-blog-id" />



                <div class="form-group">
                    <label for="new-post-title">Post Title</label>
                    <input type="text" class="form-control" id="edit-post-title">
                </div>
                <div class="form-group">
                    <label for="new-post-content">Post Content</label>
                    <textarea type="text" class="form-control" id="edit-post-content" rows="5"></textarea>
                </div>
                <button type="button" class="btn btn-success btn-update-post">Update</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success btn-update-post">Update</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>
